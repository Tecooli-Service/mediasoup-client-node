{"version":3,"file":"flight6.js","sourceRoot":"","sources":["../../../../../../dtls/src/flight/server/flight6.ts"],"names":[],"mappings":"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","sourcesContent":["import { HandshakeType } from \"../../handshake/const\";\nimport { DtlsContext } from \"../../context/dtls\";\nimport {\n  prfPreMasterSecret,\n  prfMasterSecret,\n  prfExtendedMasterSecret,\n} from \"../../cipher/prf\";\nimport { ClientKeyExchange } from \"../../handshake/message/client/keyExchange\";\nimport { ChangeCipherSpec } from \"../../handshake/message/changeCipherSpec\";\nimport { Finished } from \"../../handshake/message/finished\";\nimport { createPlaintext } from \"../../record/builder\";\nimport { TransportContext } from \"../../context/transport\";\nimport { ContentType } from \"../../record/const\";\nimport { createCipher } from \"../../cipher/create\";\nimport { CipherContext } from \"../../context/cipher\";\nimport { FragmentedHandshake } from \"../../record/message/fragment\";\nimport { Flight } from \"../flight\";\nimport debug from \"debug\";\n\nconst log = debug(\"werift/dtls/flight6\");\n\nexport class Flight6 extends Flight {\n  constructor(\n    udp: TransportContext,\n    dtls: DtlsContext,\n    private cipher: CipherContext\n  ) {\n    super(udp, dtls, 6);\n  }\n\n  handleHandshake(handshake: FragmentedHandshake) {\n    this.dtls.bufferHandshakeCache([handshake], false, 5);\n\n    const message = (() => {\n      switch (handshake.msg_type) {\n        case HandshakeType.client_key_exchange:\n          return ClientKeyExchange.deSerialize(handshake.fragment);\n        case HandshakeType.finished:\n          return Finished.deSerialize(handshake.fragment);\n      }\n    })();\n\n    if (message) {\n      handlers[message.msgType]({ dtls: this.dtls, cipher: this.cipher })(\n        message\n      );\n    }\n  }\n\n  exec() {\n    if (this.dtls.flight === 6) {\n      log(\"flight6 twice\");\n      this.send(this.dtls.lastMessage);\n      return;\n    }\n    this.dtls.flight = 6;\n\n    const messages = [this.sendChangeCipherSpec(), this.sendFinished()];\n    this.dtls.lastMessage = messages;\n    this.transmit(messages);\n  }\n\n  sendChangeCipherSpec() {\n    const changeCipherSpec = ChangeCipherSpec.createEmpty().serialize();\n    const packets = createPlaintext(this.dtls)(\n      [{ type: ContentType.changeCipherSpec, fragment: changeCipherSpec }],\n      ++this.dtls.recordSequenceNumber\n    );\n    const buf = Buffer.concat(packets.map((v) => v.serialize()));\n    return buf;\n  }\n\n  sendFinished() {\n    const cache = Buffer.concat(\n      this.dtls.handshakeCache.map((v) => v.data.serialize())\n    );\n\n    const localVerifyData = this.cipher.verifyData(cache);\n    const finish = new Finished(localVerifyData);\n\n    this.dtls.epoch = 1;\n    const [packet] = this.createPacket([finish]);\n    this.dtls.recordSequenceNumber = 0;\n\n    const buf = this.cipher.encryptPacket(packet).serialize();\n    return buf;\n  }\n}\n\nconst handlers: {\n  [key: number]: (contexts: {\n    dtls: DtlsContext;\n    cipher: CipherContext;\n  }) => (message: any) => void;\n} = {};\n\nhandlers[HandshakeType.client_key_exchange] = ({ cipher, dtls }) => (\n  message: ClientKeyExchange\n) => {\n  cipher.remoteKeyPair = {\n    curve: cipher.namedCurve,\n    publicKey: message.publicKey,\n  };\n  if (\n    !cipher.remoteKeyPair.publicKey ||\n    !cipher.localKeyPair ||\n    !cipher.remoteRandom ||\n    !cipher.localRandom\n  )\n    throw new Error();\n\n  const preMasterSecret = prfPreMasterSecret(\n    cipher.remoteKeyPair.publicKey,\n    cipher.localKeyPair.privateKey,\n    cipher.localKeyPair.curve\n  );\n\n  log(\n    \"extendedMasterSecret\",\n    dtls.options.extendedMasterSecret,\n    dtls.remoteExtendedMasterSecret\n  );\n\n  const handshakes = Buffer.concat(\n    dtls.handshakeCache.map((v) => v.data.serialize())\n  );\n  cipher.masterSecret =\n    dtls.options.extendedMasterSecret && dtls.remoteExtendedMasterSecret\n      ? prfExtendedMasterSecret(preMasterSecret, handshakes)\n      : prfMasterSecret(\n          preMasterSecret,\n          cipher.remoteRandom.serialize(),\n          cipher.localRandom.serialize()\n        );\n\n  cipher.cipher = createCipher(cipher.cipherSuite!);\n  cipher.cipher.init(\n    cipher.masterSecret,\n    cipher.localRandom.serialize(),\n    cipher.remoteRandom.serialize()\n  );\n};\n\nhandlers[HandshakeType.finished] = () => (message: Finished) => {\n  log(\"finished\", message);\n};\n"]}