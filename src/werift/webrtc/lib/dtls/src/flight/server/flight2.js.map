{"version":3,"file":"flight2.js","sourceRoot":"","sources":["../../../../../../dtls/src/flight/server/flight2.ts"],"names":[],"mappings":"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","sourcesContent":["import { ClientHello } from \"../../handshake/message/client/hello\";\nimport { DtlsRandom } from \"../../handshake/random\";\nimport { createFragments, createPlaintext } from \"../../record/builder\";\nimport { TransportContext } from \"../../context/transport\";\nimport { DtlsContext } from \"../../context/dtls\";\nimport { EllipticCurves } from \"../../handshake/extensions/ellipticCurves\";\nimport { Signature } from \"../../handshake/extensions/signature\";\nimport { generateKeyPair } from \"../../cipher/namedCurve\";\nimport { CipherContext } from \"../../context/cipher\";\nimport { ServerHelloVerifyRequest } from \"../../handshake/message/server/helloVerifyRequest\";\nimport { randomBytes } from \"crypto\";\nimport {\n  CipherSuite,\n  NamedCurveAlgorithm,\n  NamedCurveAlgorithms,\n  SignatureAlgorithm,\n} from \"../../cipher/const\";\nimport { ContentType } from \"../../record/const\";\nimport { UseSRTP } from \"../../handshake/extensions/useSrtp\";\nimport { SrtpContext } from \"../../context/srtp\";\nimport debug from \"debug\";\nimport { ExtendedMasterSecret } from \"../../handshake/extensions/extendedMasterSecret\";\nimport { RenegotiationIndication } from \"../../handshake/extensions/renegotiationIndication\";\n\nconst log = debug(\"werift/dtls/flight/server/flight2\");\n\n// HelloVerifyRequest do not retransmit\n\nexport const flight2 = (\n  udp: TransportContext,\n  dtls: DtlsContext,\n  cipher: CipherContext,\n  srtp: SrtpContext\n) => (clientHello: ClientHello) => {\n  dtls.flight = 2;\n\n  clientHello.extensions.forEach((extension) => {\n    switch (extension.type) {\n      case EllipticCurves.type:\n        {\n          const curves = EllipticCurves.fromData(extension.data).data;\n          log(\"curves\", curves);\n          const curve = curves.find((curve) =>\n            Object.values(NamedCurveAlgorithm).includes(curve as any)\n          ) as NamedCurveAlgorithms;\n          cipher.namedCurve = curve;\n          log(\"curve selected\", cipher.namedCurve);\n        }\n        break;\n      case Signature.type:\n        {\n          if (!cipher.signatureHashAlgorithm)\n            throw new Error(\"need to set certificate\");\n\n          const signatureHash = Signature.fromData(extension.data).data;\n          log(\"hash,signature\", signatureHash);\n          const signature = signatureHash.find(\n            (v) => v.signature === cipher.signatureHashAlgorithm?.signature\n          )?.signature;\n          const hash = signatureHash.find(\n            (v) => v.hash === cipher.signatureHashAlgorithm?.hash\n          )?.hash;\n          if (signature == undefined || hash == undefined)\n            throw new Error(\"invalid signatureHash\");\n        }\n        break;\n      case UseSRTP.type:\n        {\n          if (!dtls.options?.srtpProfiles) return;\n          if (dtls.options.srtpProfiles.length === 0) return;\n\n          const useSrtp = UseSRTP.fromData(extension.data);\n          log(\"srtp profiles\", useSrtp.profiles);\n          const profile = SrtpContext.findMatchingSRTPProfile(\n            useSrtp.profiles,\n            dtls.options?.srtpProfiles\n          );\n          if (!profile) {\n            throw new Error();\n          }\n          srtp.srtpProfile = profile;\n          log(\"srtp profile selected\", srtp.srtpProfile);\n        }\n        break;\n      case ExtendedMasterSecret.type:\n        {\n          dtls.remoteExtendedMasterSecret = true;\n        }\n        break;\n      case RenegotiationIndication.type:\n        {\n          log(\"RenegotiationIndication\", extension.data);\n        }\n        break;\n    }\n  });\n\n  cipher.localRandom = new DtlsRandom();\n  cipher.remoteRandom = DtlsRandom.from(clientHello.random);\n\n  const suites = clientHello.cipherSuites;\n  log(\"cipher suites\", suites);\n  const suite = (() => {\n    switch (cipher.signatureHashAlgorithm?.signature) {\n      case SignatureAlgorithm.ecdsa:\n        return CipherSuite.TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256;\n      case SignatureAlgorithm.rsa:\n        return CipherSuite.TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256;\n    }\n  })();\n  if (suite === undefined || !suites.includes(suite)) {\n    throw new Error(\"dtls cipher suite negotiation failed\");\n  }\n  cipher.cipherSuite = suite;\n  log(\"selected cipherSuite\", cipher.cipherSuite);\n\n  cipher.localKeyPair = generateKeyPair(cipher.namedCurve);\n\n  dtls.cookie = randomBytes(20);\n  const helloVerifyReq = new ServerHelloVerifyRequest(\n    {\n      major: 255 - 1,\n      minor: 255 - 2,\n    },\n    dtls.cookie\n  );\n  const fragments = createFragments(dtls)([helloVerifyReq]);\n  const packets = createPlaintext(dtls)(\n    fragments.map((fragment) => ({\n      type: ContentType.handshake,\n      fragment: fragment.serialize(),\n    })),\n    ++dtls.recordSequenceNumber\n  );\n\n  const buf = packets.map((v) => v.serialize());\n  buf.forEach((v) => udp.send(v));\n};\n"]}