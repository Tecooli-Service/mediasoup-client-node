{"version":3,"file":"rtpSender.js","sourceRoot":"","sources":["../../../../src/media/rtpSender.ts"],"names":[],"mappings":";;;;AAAA,mCAAqC;AACrC,0DAA0B;AAC1B,mCAAgC;AAChC,8DAA4B;AAC5B,mDAA6B;AAC7B,0CAc0B;AAC1B,oDAAuD;AACvD,4DAA8D;AAC9D,sCAAkC;AAGlC,oCAAoE;AAEpE,qDAA2E;AAC3E,mCAA2C;AAE3C,MAAM,GAAG,GAAG,eAAK,CAAC,yBAAyB,CAAC,CAAC;AAE7C,MAAM,gBAAgB,GAAG,GAAG,CAAC;AAC7B,MAAM,SAAS,GAAG,IAAI,CAAC;AAEvB,MAAa,YAAY;IAyCvB,YACS,WAAoC,EACpC,aAA+B;QAD/B,gBAAW,GAAX,WAAW,CAAyB;QACpC,kBAAa,GAAb,aAAa,CAAkB;QA1C/B,SAAI,GAAG,QAAQ,CAAC;QAChB,SAAI,GACX,OAAO,IAAI,CAAC,WAAW,KAAK,QAAQ;YAClC,CAAC,CAAC,IAAI,CAAC,WAAW;YAClB,CAAC,CAAC,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC;QACnB,SAAI,GAAG,eAAM,CAAC,MAAM,CAAC,IAAI,EAAE,oBAAW,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;QAC9C,aAAQ,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC;QACrB,YAAO,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC;QACpB,YAAO,GAAG,IAAI,iBAAK,EAAE,CAAC;QACtB,WAAM,GAAG,IAAI,iBAAK,EAAgB,CAAC;QACnC,cAAS,GAAG,IAAI,oCAAwB,EAAE,CAAC;QAQ5C,iBAAY,GAAG,EAAE,CAAC;QAClB,iBAAY,GAAG,CAAC,CAAC;QACjB,eAAU,GAAG,CAAC,CAAC;QACf,gBAAW,GAAG,CAAC,CAAC;QAMhB,oBAAe,GAAG,CAAC,CAAC;QACpB,cAAS,GAAG,CAAC,CAAC;QACd,aAAQ,GAAgB,EAAE,CAAC;QAsEnC,eAAU,GAAG,KAAK,CAAC;QAvDjB,aAAa,CAAC,aAAa,CAAC,SAAS,CAAC,CAAC,KAAK,EAAE,EAAE;YAC9C,IAAI,KAAK,KAAK,WAAW,EAAE;gBACzB,IAAI,CAAC,OAAO,CAAC,OAAO,EAAE,CAAC;aACxB;QACH,CAAC,CAAC,CAAC;QACH,IAAI,WAAW,YAAY,wBAAgB,EAAE;YAC3C,IAAI,CAAC,aAAa,CAAC,WAAW,CAAC,CAAC;SACjC;IACH,CAAC;IApBD,IAAI,KAAK,CAAC,KAA4B;QACpC,IAAI,CAAC,MAAM,GAAG,KAAK,CAAC;QACpB,IAAI,IAAI,CAAC,KAAK;YAAE,IAAI,CAAC,KAAK,CAAC,KAAK,GAAG,KAAK,CAAC;IAC3C,CAAC;IAmBD,aAAa,CAAC,KAAuB;QACnC,IAAI,KAAK,CAAC,OAAO;YAAE,MAAM,IAAI,KAAK,CAAC,gBAAgB,CAAC,CAAC;QAErD,IAAI,IAAI,CAAC,YAAY,EAAE;YACrB,IAAI,CAAC,YAAY,EAAE,CAAC;SACrB;QAED,MAAM,EAAE,WAAW,EAAE,GAAG,KAAK,CAAC,YAAY,CAAC,SAAS,CAAC,CAAC,GAAG,EAAE,EAAE;YAC3D,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;QACpB,CAAC,CAAC,CAAC;QACH,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC;QACnB,IAAI,CAAC,YAAY,GAAG,WAAW,CAAC;QAEhC,KAAK,CAAC,KAAK,GAAG,IAAI,CAAC,MAAM,CAAC;IAC5B,CAAC;IAED,KAAK,CAAC,YAAY,CAAC,KAA8B;QAC/C,IAAI,KAAK,KAAK,IAAI,EAAE;YAClB,YAAY;YACZ,OAAO;SACR;QAED,IAAI,KAAK,CAAC,OAAO;YAAE,MAAM,IAAI,KAAK,CAAC,gBAAgB,CAAC,CAAC;QAErD,IAAI,IAAI,CAAC,cAAc,IAAI,SAAS,EAAE;YACpC,MAAM,MAAM,GACV,KAAK,CAAC,MAAM,IAAI,CAAC,MAAM,KAAK,CAAC,YAAY,CAAC,SAAS,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC,MAAM,CAAC;YAEnE,IAAI,CAAC,UAAU,CAAC,MAAM,CAAC,CAAC;SACzB;QAED,IAAI,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC;QAC1B,GAAG,CAAC,cAAc,EAAE,KAAK,CAAC,IAAI,EAAE,KAAK,CAAC,GAAG,CAAC,CAAC;IAC7C,CAAC;IAED,IAAI,KAAK;QACP,OAAO,IAAI,CAAC,aAAa,CAAC,KAAK,KAAK,WAAW,CAAC;IAClD,CAAC;IAED,YAAY;IACZ,IAAI;QACF,IAAI,CAAC,KAAK,GAAG,SAAS,CAAC;QACvB,IAAI,CAAC,UAAU,GAAG,KAAK,CAAC;IAC1B,CAAC;IAGD,KAAK,CAAC,OAAO;QACX,IAAI,IAAI,CAAC,UAAU;YAAE,OAAO;QAC5B,IAAI,CAAC,UAAU,GAAG,IAAI,CAAC;QAEvB,OAAO,IAAI,CAAC,UAAU,EAAE;YACtB,MAAM,cAAK,CAAC,GAAG,GAAG,IAAI,CAAC,MAAM,EAAE,GAAG,IAAI,CAAC,CAAC;YAExC,MAAM,OAAO,GAAiB;gBAC5B,IAAI,kBAAY,CAAC;oBACf,IAAI,EAAE,IAAI,CAAC,IAAI;oBACf,UAAU,EAAE,IAAI,oBAAc,CAAC;wBAC7B,YAAY,EAAE,IAAI,CAAC,YAAY;wBAC/B,YAAY,EAAE,IAAI,CAAC,YAAY;wBAC/B,WAAW,EAAE,IAAI,CAAC,WAAW;wBAC7B,UAAU,EAAE,IAAI,CAAC,UAAU;qBAC5B,CAAC;iBACH,CAAC;aACH,CAAC;YACF,IAAI,IAAI,CAAC,KAAK,EAAE;gBACd,OAAO,CAAC,IAAI,CACV,IAAI,iCAA2B,CAAC;oBAC9B,MAAM,EAAE;wBACN,IAAI,4BAAsB,CAAC;4BACzB,MAAM,EAAE,IAAI,CAAC,IAAI;4BACjB,KAAK,EAAE;gCACL,IAAI,2BAAqB,CAAC,EAAE,IAAI,EAAE,CAAC,EAAE,IAAI,EAAE,IAAI,CAAC,KAAK,EAAE,CAAC;6BACzD;yBACF,CAAC;qBACH;iBACF,CAAC,CACH,CAAC;aACH;YACD,IAAI,CAAC,GAAG,GAAG,CAAC,IAAI,CAAC,YAAY,IAAI,GAAG,CAAC,GAAG,WAAW,CAAC;YACpD,IAAI,CAAC,OAAO,GAAG,IAAI,CAAC,GAAG,EAAE,GAAG,IAAI,CAAC;YAEjC,IAAI;gBACF,MAAM,IAAI,CAAC,aAAa,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC;aAC5C;YAAC,OAAO,KAAK,EAAE;gBACd,MAAM,cAAK,CAAC,GAAG,GAAG,IAAI,CAAC,MAAM,EAAE,GAAG,IAAI,CAAC,CAAC;aACzC;SACF;IACH,CAAC;IAEO,UAAU,CAAC,EAAE,cAAc,EAAE,SAAS,EAAa;QACzD,IAAI,IAAI,CAAC,cAAc,IAAI,SAAS,EAAE;YACpC,IAAI,CAAC,SAAS,GAAG,iBAAS,CAAC,IAAI,CAAC,cAAc,EAAE,CAAC,cAAc,CAAC,CAAC;SAClE;QACD,IAAI,IAAI,CAAC,SAAS,IAAI,SAAS,EAAE;YAC/B,IAAI,CAAC,eAAe,GAAG,MAAM,CAC3B,iBAAS,CAAC,MAAM,CAAC,IAAI,CAAC,SAAS,CAAC,EAAE,MAAM,CAAC,CAAC,SAAS,CAAC,CAAC,CACtD,CAAC;SACH;QACD,IAAI,CAAC,QAAQ,GAAG,EAAE,CAAC;QACnB,GAAG,CAAC,YAAY,EAAE,IAAI,CAAC,cAAc,EAAE,cAAc,EAAE,IAAI,CAAC,SAAS,CAAC,CAAC;IACzE,CAAC;IAED,OAAO,CAAC,GAAuB;QAC7B,MAAM,EAAE,UAAU,EAAE,GAAG,IAAI,CAAC;QAC5B,IAAI,CAAC,IAAI,CAAC,KAAK,IAAI,CAAC,UAAU;YAAE,OAAO;QAEvC,GAAG,GAAG,MAAM,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,eAAS,CAAC,WAAW,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC;QAE9D,MAAM,MAAM,GAAG,GAAG,CAAC,MAAM,CAAC;QAC1B,MAAM,CAAC,IAAI,GAAG,IAAI,CAAC,IAAI,CAAC;QACxB,8CAA8C;QAC9C,MAAM,CAAC,SAAS,GAAG,MAAM,CACvB,iBAAS,CAAC,MAAM,CAAC,MAAM,CAAC,SAAS,CAAC,EAAE,MAAM,CAAC,IAAI,CAAC,eAAe,CAAC,CAAC,CAClE,CAAC;QACF,MAAM,CAAC,cAAc,GAAG,iBAAS,CAAC,MAAM,CAAC,cAAc,EAAE,IAAI,CAAC,SAAS,CAAC,CAAC;QACzE,IAAI,CAAC,SAAS,GAAG,MAAM,CAAC,SAAS,CAAC;QAClC,IAAI,CAAC,cAAc,GAAG,MAAM,CAAC,cAAc,CAAC;QAE5C,IAAI,CAAC,KAAK,GAAG,UAAU,CAAC,IAAI,CAAC,KAAK,CAAC;QAEnC,MAAM,CAAC,UAAU,GAAG,UAAU,CAAC,gBAAgB;aAC5C,GAAG,CAAC,CAAC,SAAS,EAAE,EAAE;YACjB,MAAM,OAAO,GAAG,CAAC,GAAG,EAAE;gBACpB,QAAQ,SAAS,CAAC,GAAG,EAAE;oBACrB,KAAK,gCAAiB,CAAC,OAAO;wBAC5B,OAAO,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC,KAAK,CAAC,CAAC;oBACvC,KAAK,gCAAiB,CAAC,eAAe;wBACpC,IAAI,UAAU,EAAE,GAAG,EAAE;4BACnB,OAAO,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,CAAC;yBACpC;wBACD,OAAO;oBACT,KAAK,gCAAiB,CAAC,eAAe;wBACpC,IAAI,CAAC,aAAa,CAAC,uBAAuB,GAAG,iBAAS,CACpD,IAAI,CAAC,aAAa,CAAC,uBAAuB,EAC1C,CAAC,CACF,CAAC;wBACF,OAAO,qBAAY,CACjB,CAAC,CAAC,CAAC,EACH,CAAC,IAAI,CAAC,aAAa,CAAC,uBAAuB,CAAC,CAC7C,CAAC;oBACJ,KAAK,gCAAiB,CAAC,WAAW;wBAChC,MAAM,GAAG,GAAG,MAAM,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;wBAC5B,MAAM,IAAI,GAAG,CAAC,eAAO,EAAE,IAAI,GAAG,CAAC,GAAG,WAAW,CAAC;wBAC9C,GAAG,CAAC,WAAW,CAAC,MAAM,CAAC,IAAI,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC,CAAC;wBACpC,OAAO,GAAG,CAAC;iBACd;YACH,CAAC,CAAC,EAAE,CAAC;YAEL,IAAI,OAAO;gBAAE,OAAO,EAAE,EAAE,EAAE,SAAS,CAAC,EAAE,EAAE,OAAO,EAAE,CAAC;QACpD,CAAC,CAAC;aACD,MAAM,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAgB,CAAC;QAEnC,IAAI,CAAC,YAAY,GAAG,eAAO,EAAE,CAAC;QAC9B,IAAI,CAAC,YAAY,GAAG,GAAG,CAAC,MAAM,CAAC,SAAS,CAAC;QACzC,IAAI,CAAC,UAAU,IAAI,GAAG,CAAC,OAAO,CAAC,MAAM,CAAC;QACtC,IAAI,CAAC,WAAW,GAAG,MAAM,CAAC,iBAAS,CAAC,MAAM,CAAC,IAAI,CAAC,WAAW,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC;QAEnE,GAAG,CAAC,MAAM,GAAG,MAAM,CAAC;QACpB,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;QACxB,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC,gBAAgB,CAAC,CAAC;QAEvD,MAAM,IAAI,GAAG,IAAI,CAAC,aAAa,CAAC,OAAO,CAAC,GAAG,CAAC,OAAO,EAAE,MAAM,CAAC,CAAC;QAE7D,IAAI,CAAC,OAAO,EAAE,CAAC;QACf,MAAM,QAAQ,GAAa;YACzB,OAAO,EAAE,IAAI,CAAC,aAAa,CAAC,uBAAuB;YACnD,IAAI;YACJ,WAAW,EAAE,iBAAS,EAAE;YACxB,QAAQ,EAAE,iBAAS,EAAE;SACtB,CAAC;QACF,IAAI,CAAC,SAAS,CAAC,aAAa,CAAC,QAAQ,CAAC,CAAC;IACzC,CAAC;IAED,gBAAgB,CAAC,UAAsB;QACrC,QAAQ,UAAU,CAAC,IAAI,EAAE;YACvB,KAAK,kBAAY,CAAC,IAAI,CAAC;YACvB,KAAK,kBAAY,CAAC,IAAI;gBACpB;oBACE,MAAM,MAAM,GAAG,UAAyC,CAAC;oBACzD,MAAM,CAAC,OAAO;yBACX,MAAM,CAAC,CAAC,MAAM,EAAE,EAAE,CAAC,MAAM,CAAC,IAAI,KAAK,IAAI,CAAC,IAAI,CAAC;yBAC7C,OAAO,CAAC,CAAC,MAAM,EAAE,EAAE;wBAClB,IAAI,IAAI,CAAC,GAAG,KAAK,MAAM,CAAC,MAAM,CAAC,GAAG,CAAC,IAAI,MAAM,CAAC,IAAI,EAAE;4BAClD,MAAM,GAAG,GACP,IAAI,CAAC,GAAG,EAAE,GAAG,IAAI,GAAG,IAAI,CAAC,OAAQ,GAAG,MAAM,CAAC,IAAI,GAAG,KAAK,CAAC;4BAC1D,IAAI,IAAI,CAAC,GAAG,KAAK,SAAS,EAAE;gCAC1B,IAAI,CAAC,GAAG,GAAG,GAAG,CAAC;6BAChB;iCAAM;gCACL,IAAI,CAAC,GAAG,GAAG,SAAS,GAAG,IAAI,CAAC,GAAG,GAAG,CAAC,CAAC,GAAG,SAAS,CAAC,GAAG,GAAG,CAAC;6BACzD;yBACF;oBACH,CAAC,CAAC,CAAC;iBACN;gBACD,MAAM;YACR,KAAK,gCAA0B,CAAC,IAAI;gBAClC;oBACE,MAAM,MAAM,GAAG,UAAwC,CAAC;oBACxD,QAAQ,MAAM,CAAC,QAAQ,CAAC,KAAK,EAAE;wBAC7B,KAAK,qBAAe,CAAC,KAAK;4BACxB;gCACE,MAAM,QAAQ,GAAG,MAAM,CAAC,QAA2B,CAAC;gCACpD,IAAI,CAAC,SAAS,CAAC,WAAW,CAAC,QAAQ,CAAC,CAAC;6BACtC;4BACD,MAAM;wBACR,KAAK,iBAAW,CAAC,KAAK;4BACpB;gCACE,MAAM,QAAQ,GAAG,MAAM,CAAC,QAAuB,CAAC;gCAEhD,QAAQ,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC,MAAM,EAAE,EAAE;oCAC/B,MAAM,GAAG,GAAG,IAAI,CAAC,QAAQ,CAAC,IAAI,CAC5B,CAAC,GAAG,EAAE,EAAE,CAAC,GAAG,CAAC,MAAM,CAAC,cAAc,KAAK,MAAM,CAC9C,CAAC;oCACF,IAAI,GAAG,EAAE;wCACP,IAAI,CAAC,aAAa,CAAC,OAAO,CAAC,GAAG,CAAC,OAAO,EAAE,GAAG,CAAC,MAAM,CAAC,CAAC;qCACrD;gCACH,CAAC,CAAC,CAAC;6BACJ;4BACD,MAAM;qBACT;iBACF;gBACD,MAAM;SACT;QACD,IAAI,CAAC,MAAM,CAAC,OAAO,CAAC,UAAU,CAAC,CAAC;IAClC,CAAC;CACF;AAvRD,oCAuRC","sourcesContent":["import { randomBytes } from \"crypto\";\nimport debug from \"debug\";\nimport { jspack } from \"jspack\";\nimport Event from \"rx.mini\";\nimport * as uuid from \"uuid\";\nimport {\n  Extension,\n  GenericNack,\n  RtcpPacket,\n  RtcpRrPacket,\n  RtcpSenderInfo,\n  RtcpSourceDescriptionPacket,\n  RtcpSrPacket,\n  RtcpTransportLayerFeedback,\n  RtpHeader,\n  RtpPacket,\n  SourceDescriptionChunk,\n  SourceDescriptionItem,\n  TransportWideCC,\n} from \"../../../rtp/src\";\nimport { bufferWriter } from \"../../../rtp/src/helper\";\nimport { RTP_EXTENSION_URI } from \"../extension/rtpExtension\";\nimport { sleep } from \"../helper\";\nimport { RTCDtlsTransport } from \"../transport/dtls\";\nimport { Kind } from \"../types/domain\";\nimport { milliTime, ntpTime, uint16Add, uint32Add } from \"../utils\";\nimport { RTCRtpCodecParameters, RTCRtpParameters } from \"./parameters\";\nimport { SenderBandwidthEstimator, SentInfo } from \"./senderBWE/senderBWE\";\nimport { MediaStreamTrack } from \"./track\";\n\nconst log = debug(\"werift:webrtc:rtpSender\");\n\nconst RTP_HISTORY_SIZE = 128;\nconst RTT_ALPHA = 0.85;\n\nexport class RTCRtpSender {\n  readonly type = \"sender\";\n  readonly kind =\n    typeof this.trackOrKind === \"string\"\n      ? this.trackOrKind\n      : this.trackOrKind.kind;\n  readonly ssrc = jspack.Unpack(\"!L\", randomBytes(4))[0];\n  readonly streamId = uuid.v4();\n  readonly trackId = uuid.v4();\n  readonly onReady = new Event();\n  readonly onRtcp = new Event<[RtcpPacket]>();\n  readonly senderBWE = new SenderBandwidthEstimator();\n\n  private cname?: string;\n  private disposeTrack?: () => void;\n\n  // # stats\n  private lsr?: bigint;\n  private lsrTime?: number;\n  private ntpTimestamp = 0n;\n  private rtpTimestamp = 0;\n  private octetCount = 0;\n  private packetCount = 0;\n  private rtt?: number;\n\n  // rtp\n  private sequenceNumber?: number;\n  private timestamp?: number;\n  private timestampOffset = 0;\n  private seqOffset = 0;\n  private rtpCache: RtpPacket[] = [];\n\n  private _codec?: RTCRtpCodecParameters;\n  set codec(codec: RTCRtpCodecParameters) {\n    this._codec = codec;\n    if (this.track) this.track.codec = codec;\n  }\n\n  parameters?: RTCRtpParameters;\n  track?: MediaStreamTrack;\n\n  constructor(\n    public trackOrKind: Kind | MediaStreamTrack,\n    public dtlsTransport: RTCDtlsTransport\n  ) {\n    dtlsTransport.onStateChange.subscribe((state) => {\n      if (state === \"connected\") {\n        this.onReady.execute();\n      }\n    });\n    if (trackOrKind instanceof MediaStreamTrack) {\n      this.registerTrack(trackOrKind);\n    }\n  }\n\n  registerTrack(track: MediaStreamTrack) {\n    if (track.stopped) throw new Error(\"track is ended\");\n\n    if (this.disposeTrack) {\n      this.disposeTrack();\n    }\n\n    const { unSubscribe } = track.onReceiveRtp.subscribe((rtp) => {\n      this.sendRtp(rtp);\n    });\n    this.track = track;\n    this.disposeTrack = unSubscribe;\n\n    track.codec = this._codec;\n  }\n\n  async replaceTrack(track: MediaStreamTrack | null) {\n    if (track === null) {\n      // todo impl\n      return;\n    }\n\n    if (track.stopped) throw new Error(\"track is ended\");\n\n    if (this.sequenceNumber != undefined) {\n      const header =\n        track.header || (await track.onReceiveRtp.asPromise())[0].header;\n\n      this.replaceRTP(header);\n    }\n\n    this.registerTrack(track);\n    log(\"replaceTrack\", track.ssrc, track.rid);\n  }\n\n  get ready() {\n    return this.dtlsTransport.state === \"connected\";\n  }\n\n  // todo test\n  stop() {\n    this.track = undefined;\n    this.rtcpRunner = false;\n  }\n\n  rtcpRunner = false;\n  async runRtcp() {\n    if (this.rtcpRunner) return;\n    this.rtcpRunner = true;\n\n    while (this.rtcpRunner) {\n      await sleep(500 + Math.random() * 1000);\n\n      const packets: RtcpPacket[] = [\n        new RtcpSrPacket({\n          ssrc: this.ssrc,\n          senderInfo: new RtcpSenderInfo({\n            ntpTimestamp: this.ntpTimestamp,\n            rtpTimestamp: this.rtpTimestamp,\n            packetCount: this.packetCount,\n            octetCount: this.octetCount,\n          }),\n        }),\n      ];\n      if (this.cname) {\n        packets.push(\n          new RtcpSourceDescriptionPacket({\n            chunks: [\n              new SourceDescriptionChunk({\n                source: this.ssrc,\n                items: [\n                  new SourceDescriptionItem({ type: 1, text: this.cname }),\n                ],\n              }),\n            ],\n          })\n        );\n      }\n      this.lsr = (this.ntpTimestamp >> 16n) & 0xffffffffn;\n      this.lsrTime = Date.now() / 1000;\n\n      try {\n        await this.dtlsTransport.sendRtcp(packets);\n      } catch (error) {\n        await sleep(500 + Math.random() * 1000);\n      }\n    }\n  }\n\n  private replaceRTP({ sequenceNumber, timestamp }: RtpHeader) {\n    if (this.sequenceNumber != undefined) {\n      this.seqOffset = uint16Add(this.sequenceNumber, -sequenceNumber);\n    }\n    if (this.timestamp != undefined) {\n      this.timestampOffset = Number(\n        uint32Add(BigInt(this.timestamp), BigInt(-timestamp))\n      );\n    }\n    this.rtpCache = [];\n    log(\"replaceRTP\", this.sequenceNumber, sequenceNumber, this.seqOffset);\n  }\n\n  sendRtp(rtp: Buffer | RtpPacket) {\n    const { parameters } = this;\n    if (!this.ready || !parameters) return;\n\n    rtp = Buffer.isBuffer(rtp) ? RtpPacket.deSerialize(rtp) : rtp;\n\n    const header = rtp.header;\n    header.ssrc = this.ssrc;\n    // todo : header.payloadType=parameters.codecs\n    header.timestamp = Number(\n      uint32Add(BigInt(header.timestamp), BigInt(this.timestampOffset))\n    );\n    header.sequenceNumber = uint16Add(header.sequenceNumber, this.seqOffset);\n    this.timestamp = header.timestamp;\n    this.sequenceNumber = header.sequenceNumber;\n\n    this.cname = parameters.rtcp.cname;\n\n    header.extensions = parameters.headerExtensions\n      .map((extension) => {\n        const payload = (() => {\n          switch (extension.uri) {\n            case RTP_EXTENSION_URI.sdesMid:\n              return Buffer.from(parameters.muxId);\n            case RTP_EXTENSION_URI.sdesRTPStreamID:\n              if (parameters?.rid) {\n                return Buffer.from(parameters.rid);\n              }\n              return;\n            case RTP_EXTENSION_URI.transportWideCC:\n              this.dtlsTransport.transportSequenceNumber = uint16Add(\n                this.dtlsTransport.transportSequenceNumber,\n                1\n              );\n              return bufferWriter(\n                [2],\n                [this.dtlsTransport.transportSequenceNumber]\n              );\n            case RTP_EXTENSION_URI.absSendTime:\n              const buf = Buffer.alloc(3);\n              const time = (ntpTime() >> 14n) & 0x00ffffffn;\n              buf.writeUIntBE(Number(time), 0, 3);\n              return buf;\n          }\n        })();\n\n        if (payload) return { id: extension.id, payload };\n      })\n      .filter((v) => v) as Extension[];\n\n    this.ntpTimestamp = ntpTime();\n    this.rtpTimestamp = rtp.header.timestamp;\n    this.octetCount += rtp.payload.length;\n    this.packetCount = Number(uint32Add(BigInt(this.packetCount), 1n));\n\n    rtp.header = header;\n    this.rtpCache.push(rtp);\n    this.rtpCache = this.rtpCache.slice(-RTP_HISTORY_SIZE);\n\n    const size = this.dtlsTransport.sendRtp(rtp.payload, header);\n\n    this.runRtcp();\n    const sentInfo: SentInfo = {\n      wideSeq: this.dtlsTransport.transportSequenceNumber,\n      size,\n      sendingAtMs: milliTime(),\n      sentAtMs: milliTime(),\n    };\n    this.senderBWE.rtpPacketSent(sentInfo);\n  }\n\n  handleRtcpPacket(rtcpPacket: RtcpPacket) {\n    switch (rtcpPacket.type) {\n      case RtcpSrPacket.type:\n      case RtcpRrPacket.type:\n        {\n          const packet = rtcpPacket as RtcpSrPacket | RtcpRrPacket;\n          packet.reports\n            .filter((report) => report.ssrc === this.ssrc)\n            .forEach((report) => {\n              if (this.lsr === BigInt(report.lsr) && report.dlsr) {\n                const rtt =\n                  Date.now() / 1000 - this.lsrTime! - report.dlsr / 65536;\n                if (this.rtt === undefined) {\n                  this.rtt = rtt;\n                } else {\n                  this.rtt = RTT_ALPHA * this.rtt + (1 - RTT_ALPHA) * rtt;\n                }\n              }\n            });\n        }\n        break;\n      case RtcpTransportLayerFeedback.type:\n        {\n          const packet = rtcpPacket as RtcpTransportLayerFeedback;\n          switch (packet.feedback.count) {\n            case TransportWideCC.count:\n              {\n                const feedback = packet.feedback as TransportWideCC;\n                this.senderBWE.receiveTWCC(feedback);\n              }\n              break;\n            case GenericNack.count:\n              {\n                const feedback = packet.feedback as GenericNack;\n\n                feedback.lost.forEach((seqNum) => {\n                  const rtp = this.rtpCache.find(\n                    (rtp) => rtp.header.sequenceNumber === seqNum\n                  );\n                  if (rtp) {\n                    this.dtlsTransport.sendRtp(rtp.payload, rtp.header);\n                  }\n                });\n              }\n              break;\n          }\n        }\n        break;\n    }\n    this.onRtcp.execute(rtcpPacket);\n  }\n}\n"]}