{"version":3,"file":"dtls.js","sourceRoot":"","sources":["../../../../src/transport/dtls.ts"],"names":[],"mappings":"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","sourcesContent":["import { Certificate, PrivateKey } from \"@fidm/x509\";\nimport debug from \"debug\";\nimport Event from \"rx.mini\";\nimport {\n  DtlsClient,\n  DtlsServer,\n  DtlsSocket,\n  Transport,\n} from \"../../../dtls/src\";\nimport {\n  HashAlgorithm,\n  NamedCurveAlgorithm,\n  SignatureAlgorithm,\n  SignatureHash,\n} from \"../../../dtls/src/cipher/const\";\nimport { CipherContext } from \"../../../dtls/src/context/cipher\";\nimport { Connection } from \"../../../ice/src\";\nimport {\n  RtcpPacket,\n  RtcpPacketConverter,\n  RtpHeader,\n  RtpPacket,\n  SrtcpSession,\n  SrtpSession,\n} from \"../../../rtp/src\";\nimport { sleep } from \"../helper\";\nimport { RtpRouter } from \"../media/router\";\nimport { fingerprint, isDtls, isMedia, isRtcp } from \"../utils\";\nimport { RTCIceTransport } from \"./ice\";\n\nconst log = debug(\"werift/webrtc/transport/dtls\");\n\nexport class RTCDtlsTransport {\n  state: DtlsState = \"new\";\n  role: DtlsRole = \"auto\";\n  srtpStarted = false;\n  transportSequenceNumber = 0;\n\n  dataReceiver?: (buf: Buffer) => void;\n  dtls?: DtlsSocket;\n  srtp!: SrtpSession;\n  srtcp!: SrtcpSession;\n\n  readonly onStateChange = new Event<[DtlsState]>();\n\n  private localCertificate?: RTCCertificate = this.certificates[0];\n\n  constructor(\n    readonly iceTransport: RTCIceTransport,\n    readonly router: RtpRouter,\n    readonly certificates: RTCCertificate[],\n    private readonly srtpProfiles: number[] = []\n  ) {}\n\n  get localParameters() {\n    return new RTCDtlsParameters(\n      this.localCertificate ? this.localCertificate.getFingerprints() : [],\n      this.role\n    );\n  }\n\n  async setupCertificate() {\n    if (!this.localCertificate) {\n      const {\n        certPem,\n        keyPem,\n        signatureHash,\n      } = await CipherContext.createSelfSignedCertificateWithKey(\n        {\n          signature: SignatureAlgorithm.ecdsa,\n          hash: HashAlgorithm.sha256,\n        },\n        NamedCurveAlgorithm.secp256r1\n      );\n      this.localCertificate = new RTCCertificate(\n        keyPem,\n        certPem,\n        signatureHash\n      );\n    }\n  }\n\n  async start(remoteParameters: RTCDtlsParameters) {\n    if (this.state !== \"new\") throw new Error();\n    if (remoteParameters.fingerprints.length === 0) throw new Error();\n\n    if (this.role === \"auto\") {\n      if (this.iceTransport.role === \"controlling\") {\n        this.role = \"server\";\n      } else {\n        this.role = \"client\";\n      }\n    }\n\n    this.setState(\"connecting\");\n\n    await new Promise<void>(async (r) => {\n      if (this.role === \"server\") {\n        this.dtls = new DtlsServer({\n          cert: this.localCertificate?.certPem,\n          key: this.localCertificate?.privateKey,\n          signatureHash: this.localCertificate?.signatureHash,\n          transport: createIceTransport(this.iceTransport.connection),\n          srtpProfiles: this.srtpProfiles,\n          extendedMasterSecret: true,\n        });\n      } else {\n        this.dtls = new DtlsClient({\n          cert: this.localCertificate?.certPem,\n          key: this.localCertificate?.privateKey,\n          signatureHash: this.localCertificate?.signatureHash,\n          transport: createIceTransport(this.iceTransport.connection),\n          srtpProfiles: this.srtpProfiles,\n          extendedMasterSecret: true,\n        });\n      }\n      this.dtls.onData.subscribe((buf) => {\n        if (this.dataReceiver) this.dataReceiver(buf);\n      });\n      this.dtls.onClose.once(() => {\n        this.setState(\"closed\");\n      });\n      this.dtls.onConnect.once(r);\n\n      if (this.dtls instanceof DtlsClient) {\n        await sleep(100);\n        this.dtls.connect();\n      }\n    });\n\n    if (this.srtpProfiles.length > 0) {\n      this.startSrtp();\n    }\n    this.setState(\"connected\");\n    log(\"dtls connected\");\n  }\n\n  startSrtp() {\n    if (!this.dtls) throw new Error();\n\n    if (this.srtpStarted) return;\n    this.srtpStarted = true;\n\n    const {\n      localKey,\n      localSalt,\n      remoteKey,\n      remoteSalt,\n    } = this.dtls.extractSessionKeys();\n    if (!this.dtls.srtp.srtpProfile) throw new Error(\"need srtpProfile\");\n    const config = {\n      keys: {\n        localMasterKey: localKey,\n        localMasterSalt: localSalt,\n        remoteMasterKey: remoteKey,\n        remoteMasterSalt: remoteSalt,\n      },\n      profile: this.dtls.srtp.srtpProfile,\n    };\n    this.srtp = new SrtpSession(config);\n    this.srtcp = new SrtcpSession(config);\n\n    this.iceTransport.connection.onData.subscribe((data) => {\n      if (!isMedia(data)) return;\n      if (isRtcp(data)) {\n        const dec = this.srtcp.decrypt(data);\n        const rtcps = RtcpPacketConverter.deSerialize(dec);\n        rtcps.forEach((rtcp) => this.router.routeRtcp(rtcp));\n      } else {\n        const dec = this.srtp.decrypt(data);\n        const rtp = RtpPacket.deSerialize(dec);\n        this.router.routeRtp(rtp);\n      }\n    });\n  }\n\n  readonly sendData = async (data: Buffer) => {\n    if (!this.dtls) throw new Error(\"dtls not established\");\n    await this.dtls.send(data);\n  };\n\n  sendRtp(payload: Buffer, header: RtpHeader) {\n    const enc = this.srtp.encrypt(payload, header);\n    this.iceTransport.connection.send(enc);\n    return enc.length;\n  }\n\n  async sendRtcp(packets: RtcpPacket[]) {\n    const payload = Buffer.concat(packets.map((packet) => packet.serialize()));\n    const enc = this.srtcp.encrypt(payload);\n    try {\n      await this.iceTransport.connection.send(enc);\n    } catch (error) {\n      throw new Error(\"ice\");\n    }\n  }\n\n  private setState(state: DtlsState) {\n    if (state != this.state) {\n      this.state = state;\n      this.onStateChange.execute(state);\n    }\n  }\n\n  async stop() {\n    this.setState(\"closed\");\n    // todo impl send alert\n  }\n}\n\nexport const DtlsStates = [\n  \"new\",\n  \"connecting\",\n  \"connected\",\n  \"closed\",\n  \"failed\",\n] as const;\nexport type DtlsState = typeof DtlsStates[number];\n\nexport type DtlsRole = \"auto\" | \"server\" | \"client\";\n\nexport class RTCCertificate {\n  publicKey: string;\n  privateKey: string;\n\n  constructor(\n    privateKeyPem: string,\n    public certPem: string,\n    public signatureHash: SignatureHash\n  ) {\n    const cert = Certificate.fromPEM(Buffer.from(certPem));\n    this.publicKey = cert.publicKey.toPEM();\n    this.privateKey = PrivateKey.fromPEM(Buffer.from(privateKeyPem)).toPEM();\n  }\n\n  getFingerprints(): RTCDtlsFingerprint[] {\n    return [\n      new RTCDtlsFingerprint(\n        \"sha-256\",\n        fingerprint(\n          Certificate.fromPEM(Buffer.from(this.certPem)).raw,\n          \"sha256\"\n        )\n      ),\n    ];\n  }\n}\n\nexport class RTCDtlsFingerprint {\n  constructor(public algorithm: string, public value: string) {}\n}\n\nexport class RTCDtlsParameters {\n  constructor(\n    public fingerprints: RTCDtlsFingerprint[] = [],\n    public role: \"auto\" | \"client\" | \"server\"\n  ) {}\n}\n\nclass IceTransport implements Transport {\n  constructor(private ice: Connection) {\n    ice.onData.subscribe((buf) => {\n      if (isDtls(buf)) {\n        if (this.onData) this.onData(buf);\n      }\n    });\n  }\n  onData?: (buf: Buffer) => void;\n\n  readonly send = this.ice.send;\n\n  close() {\n    this.ice.close();\n  }\n}\n\nconst createIceTransport = (ice: Connection) => new IceTransport(ice);\n"]}